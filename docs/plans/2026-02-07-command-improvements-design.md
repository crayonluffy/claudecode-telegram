# Telegram Bridge Command Improvements

## Overview

Enhance the Telegram-to-Claude Code bridge with better feedback, more commands, richer status, user settings, and improved discoverability.

## Goals

1. Real-time progress feedback during Claude execution
2. More control commands for session management and quick replies
3. Enhanced `/status` with useful context
4. User-controllable settings (verbose, coauthor, signature)
5. Better command discovery via `/help` and Telegram menu

---

## 1. Real-time Progress Feedback

### Problem
Users only see Claude's final response. No visibility into what's happening during execution.

### Solution
Add a `PostToolUse` hook that sends brief updates to Telegram.

### Example Output
```
You: "Fix the bug in auth.py"
üîç Reading auth.py...
üîß Editing auth.py (lines 42-58)
‚ñ∂Ô∏è Running: pytest tests/test_auth.py
‚úÖ Done
[Full response follows]
```

### Tool Emoji Mapping
| Tool | Emoji | Example |
|------|-------|---------|
| Read | üîç | `üîç Reading config.py` |
| Edit/Write | üîß | `üîß Editing utils.py` |
| Bash | ‚ñ∂Ô∏è | `‚ñ∂Ô∏è Running: npm test` |
| Glob/Grep | üîé | `üîé Searching *.ts` |
| Task | ü§ñ | `ü§ñ Spawning agent...` |

### Implementation
- New file: `hooks/notify-tool-use.sh`
- Triggers on `PostToolUse` event
- Only fires when `PENDING_FILE` exists (Telegram-initiated)
- Respects `/verbose` setting

---

## 2. New Control Commands

### Session Management
| Command | Action |
|---------|--------|
| `/new` | Exit current session, start fresh in same directory |
| `/new <path>` | Start new session in specified directory |
| `/pwd` | Show current working directory |
| `/project` | Show current project path + session ID |

### Quick Responses
| Command | Action |
|---------|--------|
| `/y` | Send "yes" |
| `/n` | Send "no" |
| `/ok` | Send "ok, continue" |
| `/retry` | Send "try again" |

### Tmux Control
| Command | Action |
|---------|--------|
| `/screenshot` | Capture tmux pane, send as image |
| `/scroll <n>` | Capture last N lines of output |
| `/kill` | Kill tmux session (emergency) |

### Claude Code Shortcuts
| Command | Action |
|---------|--------|
| `/commit` | Send "/commit" to Claude |
| `/undo` | Send "/undo" to Claude |
| `/diff` | Send "show me the git diff" |

---

## 3. Enhanced `/status`

### Current State
Only shows "tmux running" or "not found".

### New Output Format
```
üìç Project: /home/user/myapp
üîÄ Branch: feature/auth
üìÇ Session: a3f2c1b8
‚è±Ô∏è State: Waiting for input
üí¨ Last: "I've fixed the bug in auth.py..."
```

### Data Sources
| Field | Source |
|-------|--------|
| Project | Parse from session or tmux |
| Branch | `git branch --show-current` |
| Session | From history.jsonl |
| State | Check Claude response state |
| Last | Truncated last assistant message |

---

## 4. Settings Toggles

### Commands
| Command | Effect |
|---------|--------|
| `/verbose on/off` | Toggle tool-use notifications |
| `/coauthor on/off` | Toggle "Co-Authored-By: Claude" in commits |
| `/signature on/off` | Toggle "Generated with Claude Code" in PRs |

### Storage
File: `~/.claude/telegram_settings.json`

```json
{
  "verbose": true,
  "coauthor": false,
  "signature": false
}
```

### Coauthor/Signature Implementation
When disabled, inject instruction to Claude: "Do not add Co-Authored-By or Generated by Claude signatures to commits/PRs"

---

## 5. Command Discovery

### `/help` Output
```
üì± Telegram Bridge Commands

SESSION
  /status    - Show project, branch, state
  /new [dir] - Start fresh session
  /resume    - Pick from recent sessions
  /continue_ - Continue last session
  /stop      - Interrupt Claude (Escape)
  /kill      - Kill tmux (emergency)

QUICK REPLY
  /y /n /ok /retry

ACTIONS
  /commit /undo /diff
  /clear /loop <prompt>

VIEW
  /screenshot - Capture tmux as image
  /scroll [n] - Show last n lines
  /pwd /project

SETTINGS
  /verbose on|off
  /coauthor on|off
  /signature on|off

Tip: Just type normally to chat with Claude
```

### Telegram Bot Menu
Update `BOT_COMMANDS` to register all commands with Telegram for autocomplete.

---

## Files to Modify

| File | Changes |
|------|---------|
| `bridge.py` | New command handlers, settings logic, enhanced status |
| `hooks/notify-tool-use.sh` | New PostToolUse hook for progress |
| `hooks/send-to-telegram.sh` | Respect coauthor/signature settings |

## New Files

| File | Purpose |
|------|---------|
| `~/.claude/telegram_settings.json` | User preferences |

---

## Implementation Order

1. Settings system (foundation for other features)
2. New simple commands (/y, /n, /pwd, etc.)
3. Enhanced /status
4. /screenshot and /scroll
5. /help improvements
6. PostToolUse hook for progress
7. Coauthor/signature filtering
